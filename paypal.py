import sys, gzip, uuid
import pyxb

import gnucash, gnc, trn, cmdty, ts, split   # Bindings generated by PyXB

# main script
if len(sys.argv) > 1:
    gncfile = sys.argv[1]
else:
    print "Usage: gnuc2csv.py <gnucash_file> <account_guid>"
    exit(1)

# read GnuCash Data
try:
    f = gzip.open(gncfile)
    gncxml = f.read()
except:
    f = open(gncfile)
    gncxml = f.read()

try:
    doc = gnucash.CreateFromDocument(
          gncxml,
          location_base=gncfile)

    # create a new transaction with two splits
    obj = gnc.transaction(
        trn.id( uuid.uuid4().hex, type="guid" ),
        trn.currency( cmdty.space("ISO4217"), cmdty.id("EUR") ),
        trn.date_posted( ts.date("2013-01-24 13:00:00 +0100") ),
        trn.date_entered( ts.date("2013-01-24 13:00:00 +0100") ),
        trn.description( "sdfsdfdsf  sdfsdf" ),
        trn.splits(
            trn.split(
                split.id( uuid.uuid4().hex, type="guid" ),
                split.memo( "Account Foo, bank bar" ),
                split.reconciled_state( "c" ),
                split.value( "17850/100" ),
                split.quantity( "17850/100" ),
                split.account( "101eef64413910c2df39caf80e806891", type="guid" )),
            trn.split(
                split.id( uuid.uuid4().hex, type="guid" ),
                split.memo( "Account Bar, from foo" ),
                split.reconciled_state( "n" ),
                split.value( "-17850/100" ),
                split.quantity( "-17850/100" ),
                split.account( "3863ab20d55507e16a1c5889efcdd0a5", type="guid" ))),
        version="2.0.0" )

    doc.book.append(obj)

    print doc.toxml(encoding='utf-8')
except pyxb.UnrecognizedContentError as e:
    print '*** ERROR validating input:'
    print 'Unrecognized element "%s" at %s (details: %s)' % (e.content.expanded_name, e.content.location, e.details())
except pyxb.UnrecognizedDOMRootNodeError as e:
    print '*** ERROR matching content:'
    print e.details()
